[Unit]
Description=A distributed, reliable key-value store for the most critical data of a distributed system
Documentation=https://etcd.io/docs
After=network.target

[Service]
ExecStart=/usr/local/bin/etcd \
  --name {{ inventory_hostname }} \
  --data-dir /var/lib/etcd \
  --listen-client-urls https://{{ hostvars[inventory_hostname]['hosts'][inventory_hostname].ip }}:2379,https://127.0.0.1:2379 \
  --advertise-client-urls https://{{ hostvars[inventory_hostname]['hosts'][inventory_hostname].ip }}:2379 \
  --initial-cluster-token etcd-cluster-1 \
  --cert-file=/etc/etcd/pki/server.pem \
  --key-file=/etc/etcd/pki/server-key.pem \
  --trusted-ca-file=/etc/etcd/pki/ca.pem \
  --client-cert-auth=true \
  --listen-peer-urls https://{{ hostvars[inventory_hostname]['hosts'][inventory_hostname].ip }}:2380 \
  --initial-advertise-peer-urls https://{{ hostvars[inventory_hostname]['hosts'][inventory_hostname].ip }}:2380 \
  --peer-cert-file=/etc/etcd/pki/peer.pem \
  --peer-key-file=/etc/etcd/pki/peer-key.pem \
  --peer-trusted-ca-file=/etc/etcd/pki/ca.pem \
  --peer-client-cert-auth=true \
  --initial-cluster {% for host in groups['loadbalancers'] -%}
{{ host }}=https://{{ hosts[host].ip }}:2380{% if not loop.last %},{% endif %}
{%- endfor %} \
  --initial-cluster-state new \
  --log-level info \
  --logger zap \
  --log-outputs stderr
Restart=always
RestartSec=5s
LimitNOFILE=40000

[Install]
WantedBy=multi-user.target
